<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 calculating PTG | R for Pogressive Campaigns</title>
  <meta name="description" content="Chapter 2 calculating PTG | R for Pogressive Campaigns" />
  <meta name="generator" content="bookdown 0.11 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 calculating PTG | R for Pogressive Campaigns" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 calculating PTG | R for Pogressive Campaigns" />
  
  
  

<meta name="author" content="Josiah Parry" />


<meta name="date" content="2019-06-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html">
<link rel="next" href="ptg-sql.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R for Campaigns</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> This will be a preface</a></li>
<li class="chapter" data-level="2" data-path="calculating-ptg.html"><a href="calculating-ptg.html"><i class="fa fa-check"></i><b>2</b> calculating PTG</a></li>
<li class="chapter" data-level="3" data-path="ptg-sql.html"><a href="ptg-sql.html"><i class="fa fa-check"></i><b>3</b> ptg-sql</a></li>
<li class="chapter" data-level="4" data-path="reporting-googlesheets.html"><a href="reporting-googlesheets.html"><i class="fa fa-check"></i><b>4</b> reporting-googlesheets</a></li>
<li class="chapter" data-level="5" data-path="reporting.html"><a href="reporting.html"><i class="fa fa-check"></i><b>5</b> reporting</a></li>
<li class="chapter" data-level="6" data-path="mapping-doors-targets.html"><a href="mapping-doors-targets.html"><i class="fa fa-check"></i><b>6</b> mapping-doors-targets</a></li>
<li class="chapter" data-level="7" data-path="shiny-creating-interactive-dashboards.html"><a href="shiny-creating-interactive-dashboards.html"><i class="fa fa-check"></i><b>7</b> shiny - creating interactive dashboards</a></li>
<li class="chapter" data-level="8" data-path="google-trends-results.html"><a href="google-trends-results.html"><i class="fa fa-check"></i><b>8</b> google trends results</a><ul>
<li class="chapter" data-level="8.1" data-path="google-trends-results.html"><a href="google-trends-results.html#google-trends-data"><i class="fa fa-check"></i><b>8.1</b> Google Trends Data</a><ul>
<li class="chapter" data-level="8.1.1" data-path="google-trends-results.html"><a href="google-trends-results.html#relative-popularity"><i class="fa fa-check"></i><b>8.1.1</b> Relative Popularity</a></li>
<li class="chapter" data-level="8.1.2" data-path="google-trends-results.html"><a href="google-trends-results.html#related-queries"><i class="fa fa-check"></i><b>8.1.2</b> Related Queries</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="google-trends-results.html"><a href="google-trends-results.html#trendyy"><i class="fa fa-check"></i><b>8.2</b> <code>trendyy</code></a></li>
<li class="chapter" data-level="8.3" data-path="google-trends-results.html"><a href="google-trends-results.html#visualizing-trends"><i class="fa fa-check"></i><b>8.3</b> Visualizing Trends</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>9</b> workflow</a></li>
<li class="chapter" data-level="10" data-path="web-scraping-polling-use-case.html"><a href="web-scraping-polling-use-case.html"><i class="fa fa-check"></i><b>10</b> Web-Scraping: Polling use case</a><ul>
<li class="chapter" data-level="10.1" data-path="web-scraping-polling-use-case.html"><a href="web-scraping-polling-use-case.html#understanding-rvest"><i class="fa fa-check"></i><b>10.1</b> Understanding <code>rvest</code></a></li>
<li class="chapter" data-level="10.2" data-path="web-scraping-polling-use-case.html"><a href="web-scraping-polling-use-case.html#example"><i class="fa fa-check"></i><b>10.2</b> Example</a><ul>
<li class="chapter" data-level="10.2.1" data-path="web-scraping-polling-use-case.html"><a href="web-scraping-polling-use-case.html#date-cleaning"><i class="fa fa-check"></i><b>10.2.1</b> Date cleaning</a></li>
<li class="chapter" data-level="10.2.2" data-path="web-scraping-polling-use-case.html"><a href="web-scraping-polling-use-case.html#visualization"><i class="fa fa-check"></i><b>10.2.2</b> Visualization</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/josiahparry/r-4-campaigns" target="blank">GitHub</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R for Pogressive Campaigns</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="calculating-ptg" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> calculating PTG</h1>
<p>Goal: Demonstrate how to take raw canvassing data and calculate a PTG.</p>
<p>This writing assumes that the reader has at least a basic understanding of R and the tidyverse—particularly dplyr and ggplot2.</p>
<p>Overview:</p>
<ul>
<li>reading in data</li>
<li>aggregating</li>
<li>joining tables</li>
</ul>
<p>One of the most important metrics to a field program is the percent to goal (PTG). Field staff have a target number of pledge cards or doors to knock on. It is important for the data manger to provide a reliant and robust PTG reporting system to enable organizing directors to make informed and data driven decisions.</p>
<p>In this exercise we will use three datasets (located in the data folder).</p>
<ul>
<li><code>canvassing_results.csv</code>: canvassing results from January to March</li>
<li><code>van_turf_lookup.csv</code>: dataset containing the region codes for each van user</li>
<li><code>goals.csv</code>: dataset containing the weekly pledge card goal</li>
</ul>
<p>Steps:</p>
<ul>
<li>read in canvassing results</li>
<li>read in turf code look up table</li>
<li>create new week variable</li>
<li>aggregate on the weekly level</li>
<li>read in goal and calculate PTG</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(lubridate)

canvass &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/canvassing_results.csv&quot;</span>)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   van_id = col_double(),
##   date = col_date(format = &quot;&quot;),
##   vol_yes = col_double()
## )</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">canvass</code></pre>
<pre><code>## # A tibble: 6,671 x 3
##    van_id date       vol_yes
##     &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;
##  1      1 2019-03-15       1
##  2      2 2019-01-30       1
##  3      3 2019-02-27       0
##  4      4 2019-02-21       0
##  5      5 2019-01-13       0
##  6      6 2019-01-29       0
##  7      7 2019-01-07       0
##  8      8 2019-02-15       0
##  9      9 2019-01-30       0
## 10     10 2019-03-06       0
## # … with 6,661 more rows</code></pre>
<p>I always briefly inspect my data using the <code>count()</code> function. Let’s count the number of individuals who marked volunteer yes.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">count</span>(canvass, vol_yes)</code></pre>
<pre><code>## # A tibble: 2 x 2
##   vol_yes     n
##     &lt;dbl&gt; &lt;int&gt;
## 1       0  4617
## 2       1  2054</code></pre>
<p>That is a lot of volunteers! They will go into the volunter recruitment and management pipeline and hopefully convert into some volunteer shifts. But which region are these potential volunteers in? To figure this out we will have to read in the <code>van_turf_lookup.csv</code> dataset.</p>
<pre class="sourceCode r"><code class="sourceCode r">turf_lookup &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/van_turf_lookup.csv&quot;</span>)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   van_id = col_double(),
##   turf_code = col_character()
## )</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">turf_lookup </code></pre>
<pre><code>## # A tibble: 6,004 x 2
##    van_id turf_code
##     &lt;dbl&gt; &lt;chr&gt;    
##  1      1 B        
##  2      2 E        
##  3      3 E        
##  4      4 B        
##  5      5 C        
##  6      6 E        
##  7      7 B        
##  8      8 C        
##  9      9 D        
## 10     10 A        
## # … with 5,994 more rows</code></pre>
<p>Here we see that there are only two variables, <code>van_id</code>, and <code>turf_code</code>. This is a very common structure in relational data architectures. Because this table and the <code>canvass</code> table both share the <code>van_id</code> column we can merge the who based on this. This is referred to as a <em>“common identifier”</em>. The operation of joining two tables together is called a join.</p>
<p>For more on joins and relational data please read <a href="https://r4ds.had.co.nz/relational-data.html">chapter 13 of R for Data Science</a> by Hadley Wickham.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">left_join</span>(canvass, turf_lookup, <span class="dt">by =</span> <span class="st">&quot;van_id&quot;</span>) </code></pre>
<pre><code>## # A tibble: 6,671 x 4
##    van_id date       vol_yes turf_code
##     &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt; &lt;chr&gt;    
##  1      1 2019-03-15       1 B        
##  2      2 2019-01-30       1 E        
##  3      3 2019-02-27       0 E        
##  4      4 2019-02-21       0 B        
##  5      5 2019-01-13       0 C        
##  6      6 2019-01-29       0 E        
##  7      7 2019-01-07       0 B        
##  8      8 2019-02-15       0 C        
##  9      9 2019-01-30       0 D        
## 10     10 2019-03-06       0 A        
## # … with 6,661 more rows</code></pre>
<p>This code node provides the turf codes for each <code>van_id</code>, but we still do not have the week that each observation belongs to.We are interested in the weekly pledge card goal so it is important to extract the calendar week from the date field. We will use the function <code>lubridate::week()</code> to do this.</p>
<p>We will pipe the resultant table from the join into a mutate call where we will create this new variable and save it to an object called <code>canvass_clean</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">canvass_clean &lt;-<span class="st"> </span><span class="kw">left_join</span>(canvass, turf_lookup, <span class="dt">by =</span> <span class="st">&quot;van_id&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">week =</span> <span class="kw">week</span>(date))

canvass_clean</code></pre>
<pre><code>## # A tibble: 6,671 x 5
##    van_id date       vol_yes turf_code  week
##     &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1      1 2019-03-15       1 B            11
##  2      2 2019-01-30       1 E             5
##  3      3 2019-02-27       0 E             9
##  4      4 2019-02-21       0 B             8
##  5      5 2019-01-13       0 C             2
##  6      6 2019-01-29       0 E             5
##  7      7 2019-01-07       0 B             1
##  8      8 2019-02-15       0 C             7
##  9      9 2019-01-30       0 D             5
## 10     10 2019-03-06       0 A            10
## # … with 6,661 more rows</code></pre>
<p>We can use <code>count()</code> again to explore the pledge cards by region and week. We can add unquoted column names as arguments to <code>count()</code> which will be used to group the data.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">count</span>(canvass_clean, turf_code)</code></pre>
<pre><code>## # A tibble: 6 x 2
##   turf_code     n
##   &lt;chr&gt;     &lt;int&gt;
## 1 A          1137
## 2 B          1101
## 3 C          1159
## 4 D          1114
## 5 E          1044
## 6 F          1116</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">count</span>(canvass_clean, week)</code></pre>
<pre><code>## # A tibble: 11 x 2
##     week     n
##    &lt;dbl&gt; &lt;int&gt;
##  1     1   651
##  2     2   629
##  3     3   552
##  4     4   637
##  5     5   607
##  6     6   614
##  7     7   617
##  8     8   643
##  9     9   641
## 10    10   640
## 11    11   440</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">count</span>(canvass_clean, turf_code, week)</code></pre>
<pre><code>## # A tibble: 66 x 3
##    turf_code  week     n
##    &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;
##  1 A             1   114
##  2 A             2   109
##  3 A             3    96
##  4 A             4   121
##  5 A             5    95
##  6 A             6    99
##  7 A             7    78
##  8 A             8   111
##  9 A             9   119
## 10 A            10   119
## # … with 56 more rows</code></pre>
<p>Though these counts (you may be more familiar with the phrase <em>cross-tabs</em>) are extremely useful, we still want to know the number of volunteers pledged. For more control over the aggregate measures, we will use <code>dplyr::group_by()</code> and <code>dplyr::summarise()</code> (for more see <a href="https://r4ds.had.co.nz/transform.html#grouped-summaries-with-summarise">chapter 5.6</a> in R for Data Science).</p>
<p>We will create a new table called <code>weekly_canvass</code> which is grouped by turf code and week. This table will have a column for <code>turf_code</code>, <code>week,</code> the number of people pledged to vote <code>n_pledged</code>, and the number of people who indicated they would volunteer <code>vol_yes</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">weekly_canvass &lt;-<span class="st"> </span>canvass_clean <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(turf_code, week) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n_pledged =</span> <span class="kw">n</span>(),
            <span class="dt">vol_yes =</span> <span class="kw">sum</span>(vol_yes))

weekly_canvass</code></pre>
<pre><code>## # A tibble: 66 x 4
## # Groups:   turf_code [6]
##    turf_code  week n_pledged vol_yes
##    &lt;chr&gt;     &lt;dbl&gt;     &lt;int&gt;   &lt;dbl&gt;
##  1 A             1       114      41
##  2 A             2       109      28
##  3 A             3        96      33
##  4 A             4       121      34
##  5 A             5        95      32
##  6 A             6        99      29
##  7 A             7        78      28
##  8 A             8       111      29
##  9 A             9       119      34
## 10 A            10       119      27
## # … with 56 more rows</code></pre>
<p>Now that we have our counts of pledges and volunteers by week and turf code we need to compare this to their weekly goal. The weekly goals are in <code>goals.csv</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">goals &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/goals.csv&quot;</span>)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   week = col_double(),
##   region = col_character(),
##   goal = col_double()
## )</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">goals</code></pre>
<pre><code>## # A tibble: 312 x 3
##     week region  goal
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
##  1     1 A        120
##  2     1 B        130
##  3     1 C         70
##  4     1 D        120
##  5     1 E         90
##  6     1 F        130
##  7     2 A        110
##  8     2 B         90
##  9     2 C        130
## 10     2 D         70
## # … with 302 more rows</code></pre>
<p>Again, this data will need to be joined. What is unique here though is that there is not a single common identifier column. We will need to join on <em>two</em> columns. Namely, region (turf code), and week. Notice that we have mismatched names. To perform a join in this scenario we will need to provide a named vector to the <code>by</code> argument (more on named vectors in <a href="https://r4ds.had.co.nz/vectors.html#naming-vectors">chapter 20.4.4</a> in R for Data Science). The name of the vector element is the column name in the left hand table and the value is the name of the column in the right hand table.</p>
<p>In our case, the left hand table is <code>weekly_canvass</code> which has the column name <code>turf_code</code>. The right hand table is <code>goals</code> which has the column name <code>region</code>. To match on this we have to provide the named vector <code>c(&quot;turf_code&quot; = &quot;region)</code>. Since the second column we are matching on is <code>week</code> which is present in both tables, this element does not have to be named. Thus the vector we will use is <code>c(&quot;turf_code&quot; = &quot;region&quot;, &quot;week&quot;)</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">left_join</span>(weekly_canvass, goals, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;turf_code&quot;</span> =<span class="st"> &quot;region&quot;</span>, <span class="st">&quot;week&quot;</span>))</code></pre>
<pre><code>## # A tibble: 66 x 5
## # Groups:   turf_code [6]
##    turf_code  week n_pledged vol_yes  goal
##    &lt;chr&gt;     &lt;dbl&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;
##  1 A             1       114      41   120
##  2 A             2       109      28   110
##  3 A             3        96      33    60
##  4 A             4       121      34    60
##  5 A             5        95      32    90
##  6 A             6        99      29   120
##  7 A             7        78      28   110
##  8 A             8       111      29   130
##  9 A             9       119      34   130
## 10 A            10       119      27   130
## # … with 56 more rows</code></pre>
<p>With this join we see that we have the goal and the actual number pledged. We’re one step away from calculating the PTG! To calculate the percent we need to divide the actual number by the goal and multiply by 100. We will do this within a mutate call after we join and save this to a new object <code>ptg</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">ptg &lt;-<span class="st"> </span><span class="kw">left_join</span>(weekly_canvass, goals, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;turf_code&quot;</span> =<span class="st"> &quot;region&quot;</span>, <span class="st">&quot;week&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ptg =</span> (n_pledged <span class="op">/</span><span class="st"> </span>goal) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>)

ptg</code></pre>
<pre><code>## # A tibble: 66 x 6
## # Groups:   turf_code [6]
##    turf_code  week n_pledged vol_yes  goal   ptg
##    &lt;chr&gt;     &lt;dbl&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 A             1       114      41   120  95  
##  2 A             2       109      28   110  99.1
##  3 A             3        96      33    60 160  
##  4 A             4       121      34    60 202. 
##  5 A             5        95      32    90 106. 
##  6 A             6        99      29   120  82.5
##  7 A             7        78      28   110  70.9
##  8 A             8       111      29   130  85.4
##  9 A             9       119      34   130  91.5
## 10 A            10       119      27   130  91.5
## # … with 56 more rows</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">ptg <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(week, ptg, <span class="dt">color =</span> turf_code)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>turf_code) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">100</span>, <span class="dt">lty =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(
    <span class="dt">panel.grid.major.x =</span> <span class="kw">element_blank</span>(),
    <span class="dt">panel.grid.minor.x =</span> <span class="kw">element_blank</span>(),
    <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>
  ) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;PTG by Turf Code&quot;</span>, 
       <span class="dt">x =</span> <span class="st">&quot;Week&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;%&quot;</span>)</code></pre>
<p><img src="r4c_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>While having a table and chart for weekly PTG is extremely useful, it is important to provide a PTG metric for the entire program.</p>
<p>To do this we will need to calculate an aggregate measure from the <code>goals</code> table and join this to an aggregated canvass table. We will start by aggregating the goals and creating a <code>total_goals</code> object. Note that in the code chunk below I rename the <code>region</code> column in the <code>group_by()</code> statement this will be useful in the future so we can avoid having to use a named vector in our join.</p>
<pre class="sourceCode r"><code class="sourceCode r">total_goals &lt;-<span class="st"> </span>goals <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(<span class="dt">turf_code =</span> region) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">goal =</span> <span class="kw">sum</span>(goal))

total_goals</code></pre>
<pre><code>## # A tibble: 6 x 2
##   turf_code  goal
##   &lt;chr&gt;     &lt;dbl&gt;
## 1 A          4390
## 2 B          4530
## 3 C          4470
## 4 D          4350
## 5 E          4640
## 6 F          4720</code></pre>
<p>Now that we have <code>total_goals</code> we need to know the total number of pledges each region has gathered. We will use the existing <code>canvass_clean</code> object and count the total number or pledges using <code>count()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">total_pledges &lt;-<span class="st"> </span><span class="kw">count</span>(canvass_clean, turf_code)
total_pledges</code></pre>
<pre><code>## # A tibble: 6 x 2
##   turf_code     n
##   &lt;chr&gt;     &lt;int&gt;
## 1 A          1137
## 2 B          1101
## 3 C          1159
## 4 D          1114
## 5 E          1044
## 6 F          1116</code></pre>
<p>Now we can join these two tables together and calculate a program wide PTG.</p>
<pre class="sourceCode r"><code class="sourceCode r">total_ptg &lt;-<span class="st"> </span><span class="kw">inner_join</span>(total_pledges, total_goals, <span class="dt">by =</span> <span class="st">&quot;turf_code&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ptg =</span> n <span class="op">/</span><span class="st"> </span>goal <span class="op">*</span><span class="st"> </span><span class="dv">100</span>)
total_ptg</code></pre>
<pre><code>## # A tibble: 6 x 4
##   turf_code     n  goal   ptg
##   &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 A          1137  4390  25.9
## 2 B          1101  4530  24.3
## 3 C          1159  4470  25.9
## 4 D          1114  4350  25.6
## 5 E          1044  4640  22.5
## 6 F          1116  4720  23.6</code></pre>
<p>Everyone loves a bar chart to visually understand their data.</p>
<pre class="sourceCode r"><code class="sourceCode r">total_ptg <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">turf_code =</span> <span class="kw">fct_rev</span>(turf_code)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(turf_code, ptg)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">100</span>, <span class="dt">lty =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Cumulative PTG&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(
    <span class="dt">panel.grid.major.x =</span> <span class="kw">element_blank</span>()
  ) </code></pre>
<p><img src="r4c_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>To Do:</p>
<ol style="list-style-type: decimal">
<li>Turn into a report</li>
<li>turn into parameterized report</li>
<li>emailing with gmailr</li>
<li>hosting and scheduling with connect</li>
</ol>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ptg-sql.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["r4c.pdf", "r4c.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
